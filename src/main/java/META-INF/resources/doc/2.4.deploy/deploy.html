<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<link type="text/css" href="../css/document.css" rel="stylesheet" />
		<title>作成したアプリのデプロイ</title>
	</head>
	<body>
		<h1><span>2.4.</span>アプリケーションのデプロイ</h1>
		<p>
			作成したアプリケーションを実際のサーバにデプロイし、運用するまでの手順は以下のようになります。
		</p>
		<ol>
			<li>WARファイルの作成</li>
			<li>作成したWARファイルをデプロイ</li>
			<li>アプリケーションの初期化</li>
		</ol>
		それぞれの詳細を以下に示します。
		<h2>WARファイルの作成</h2>
		<h3>DB初期化データのエクスポート</h3>
		<p>
			dataforms.appパッケージには、いくつかのテーブルが定義されています。
			これらのテーブルは、データベースの構築時に自動的に作成され、サンプルの初期データも登録されます。
			この初期データもまたdataforms2.jarの中に含まれていますが、今回の作業でデータが追加されています。
		</p>
		<p>
			開発の初期段階で機能を追加しましたが、これはFunctionTableへのデータ追加になります。
			また、&lt;select&gt;の選択肢を設定したため、Enum*Tableにもデータが追加されています。
			これらのデータが、運用環境の初期化時に自動的にインストールされるように設定します。
		</p>
		<p>
			「テーブル管理」を使用しdataforms.appパッケージ中のテーブルを検索し、FunctionTableとEnum*Tableをチェックし、
			「初期化データとしてエクスポート」ボタンを押下します。
		</p>
		<p class="topic">
			開発時にユーザを登録しそれをアプリケーションの初期化データとして使用したい場合は、ユーザ関連のテーブルもエクスポートしてください。
			warファイル中にユーザ関連の初期化データが存在した場合、DBの初期化時にユーザ情報を使用する・しないを切り替えることができるようになっています。
		</p>
		<figure>
			<figcaption>初期化データのエクスポートの操作</figcaption>
			<img src="initialdata1.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			上記の操作を行うと、src/main/webapp/WEB-INF/initialdata中に以下のような初期化データが作成されます。
			初期化データはjson形式ですので、テキストエディタで修正が可能です。
		</p>
		<figure>
			<figcaption>初期化データのエクスポートの結果</figcaption>
			<img src="initialdata2.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			また、開発者の権限で「機能管理」や「列挙型管理」等のページを使用すると、
			編集対処のテーブルの初期化データを出力することができます。
		</p>
		<h3>サーバログの設定</h3>
		<p>
			dataforms2.jarが出力するサーバログは、log4j2を使用して出力しています。
			プロジェクトのsrcフォルダにはlog4j2.xmlがありますので、それを適切に設定してください。
			開発時のlog4j2.xmlには、コンソールにDEBUGログを出力していますので、これを削除しておくことをお勧めします。
			詳細はlog4j2のドキュメントを参照してください。
		</p>
		<h3>jsonの整形停止</h3>
		<p>
			サーバが送信するjsonはデバックしやすいように整形されています。
			しかし、運用時には読み安くする必要はなく、送信するデータも小さいほうが良いので、整形しないように設定します。
		</p>
		<div class="filecaption">json形式の設定(web.xml)</div>
		<div class="wrappre">
			<pre>
	&lt;!-- debug&#12525;&#12464;&#12395;&#20986;&#21147;&#12377;&#12427;json&#12434;&#25972;&#24418;&#12377;&#12427;&#12363;&#12393;&#12358;&#12363;&#12434;&#25351;&#23450;&#12375;&#12414;&#12377;&#12290;--&gt;
	&lt;context-param&gt;
		&lt;param-name&gt;json-debug&lt;/param-name&gt;
		&lt;param-value&gt;<b>false</b>&lt;/param-value&gt;
	&lt;/context-param&gt;
			</pre>
		</div>
		<p class="topic">
			dataforms2.jarの各種設定は、web.xmlにまとまっています。
			この他の項目は、web.xml中のコメントを参照し、適切に設定してください。
		</p>
		<h3>クライアントログの設定</h3>
		<p>
			dataforms2.jarでは、Javascriptのconsoleをラップしたloggerという変数を用意しています。
			dataforms2.jarの*.jsでは、常にloggerを使って、コンソール出力を行っています。
			loggerを使用していれば、以下のweb.xmlの設定でログの出力レベルを調整することができます。
			デフォルトではdebugになっているので、リリース時にはinfo以上にすることをお勧めします。
		</p>
		<div class="filecaption">クライアントログレベルの設定(web.xml)</div>
		<div class="wrappre">
			<pre>
	&lt;!--
		 &#12463;&#12521;&#12452;&#12450;&#12531;&#12488;&#12525;&#12464;&#12524;&#12505;&#12523;&#12434;&#25351;&#23450;&#12375;&#12414;&#12377;&#12290;
		 javascript&#12391;&#12398;&#12467;&#12531;&#12477;&#12540;&#12523;&#20986;&#21147;&#12399;console&#12391;&#12399;&#12394;&#12367;logger&#12434;&#20351;&#29992;&#12375;&#12390;&#12367;&#12384;&#12373;&#12356;&#12290;
		 logger&#12399;&#22522;&#26412;&#30340;&#12395;console&#12434;&#12467;&#12500;&#12540;&#12375;&#12383;&#12418;&#12398;&#12391;&#12377;&#12364;&#12289;&#20197;&#19979;&#12398;&#35373;&#23450;&#12395;&#24540;&#12376;&#12390;&#12289;
		 log,info,warn,error&#12513;&#12477;&#12483;&#12488;&#12364;&#20309;&#12418;&#12375;&#12394;&#12356;&#12513;&#12477;&#12483;&#12489;&#12395;&#12394;&#12426;&#12414;&#12377;&#12290;
	 --&gt;
	&lt;context-param&gt;
		&lt;param-name&gt;client-log-level&lt;/param-name&gt;
		&lt;param-value&gt;<b>info</b>&lt;/param-value&gt;
		&lt;!-- param-value&gt;debug&lt;/param-value --&gt;
		&lt;!-- param-value&gt;info&lt;/param-value --&gt;
		&lt;!-- param-value&gt;warn&lt;/param-value --&gt;
		&lt;!-- param-value&gt;error&lt;/param-value --&gt;
		&lt;!-- param-value&gt;none&lt;/param-value --&gt;
	&lt;/context-param&gt;
			</pre>
		</div>
		<h3>開発ツールの停止</h3>
		<p>
			アプリケーションが完成し公開する段階になると、開発ツールは不要で、かつ危険な存在になってしまいます。
			そのため、以下の設定で開発ツールを停止できるようになっています。
		</p>
		<div class="filecaption">開発ツールの停止設定(web.xml)</div>
		<div class="wrappre">
			<pre>
	&lt;!--
		&#38283;&#30330;&#12484;&#12540;&#12523;&#12398;&#28961;&#21177;&#12501;&#12521;&#12464;&#12434;&#35373;&#23450;&#12375;&#12414;&#12377;&#12290;
		&#12471;&#12473;&#12486;&#12512;&#12522;&#12522;&#12540;&#12473;&#26178;&#12395;&#12399;&#28961;&#21177;&#12395;&#12375;&#12383;&#12411;&#12358;&#12364;&#23433;&#20840;&#12391;&#12377;&#12290;
	--&gt;
	&lt;context-param&gt;
		&lt;param-name&gt;disable-developer-tools&lt;/param-name&gt;
		&lt;param-value&gt;<b>true</b>&lt;/param-value&gt;
	&lt;/context-param&gt;
			</pre>
		</div>
		<h3>初期化対象パッケージの設定</h3>
		<p>
			テータベース作成時には、dataforms.appパッケージ中のテーブルクラスを検索し、それに対応するデータベーステーブルを作成します。
			今回sampleというパッケージを作成し、その中にSampleTableをというクラスを作成しました。
			SamplePageはデータベース中にSampleTableに対応するテーブルが無いと動作しません。
			そこでdataforms.appパッケージだけでなく、sampleパッケージのテーブルも自動的に作成するように設定します。
		</p>
		<div class="filecaption">初期化するパッケージの追加(web.xml)</div>
		<div class="wrappre">
			<pre>
	&lt;!--
		&#12487;&#12540;&#12479;&#12505;&#12540;&#12473;&#12398;&#20316;&#25104;&#26178;&#12395;&#12289;&#21021;&#26399;&#21270;&#12377;&#12427;&#12497;&#12483;&#12465;&#12540;&#12472;&#12522;&#12473;&#12488;&#12434;&#25351;&#23450;&#12375;&#12414;&#12377;&#12290;
		&#12497;&#12483;&#12465;&#12540;&#12472;&#21517;&#12399;,&#21306;&#20999;&#12426;&#12391;&#35079;&#25968;&#35373;&#23450;&#12377;&#12427;&#12371;&#12392;&#12364;&#12391;&#12365;&#12414;&#12377;&#12290;
		&#12487;&#12540;&#12479;&#12505;&#12540;&#12473;&#12434;&#20316;&#25104;&#12377;&#12427;&#12392;&#12365;&#12395;&#12289;&#12371;&#12398;&#12497;&#12483;&#12465;&#12540;&#12472;&#12522;&#12473;&#12488;&#12434;&#21442;&#29031;&#12375;&#12289;&#12371;&#12398;&#12497;&#12483;&#12465;&#12540;&#12472;&#20013;&#12398;&#12486;&#12540;&#12502;&#12523;&#12463;&#12521;&#12473;&#12395;&#23550;&#24540;&#12377;&#12427;&#12486;&#12540;&#12502;&#12523;&#12434;&#20316;&#25104;&#12375;&#12414;&#12377;&#12290;
		&#12394;&#12362;dataforms.app&#12497;&#12483;&#12465;&#12540;&#12472;&#12399;&#24517;&#12378;&#25351;&#23450;&#12375;&#12390;&#12367;&#12384;&#12373;&#12356;&#12290;
	--&gt;
	&lt;context-param&gt;
		&lt;param-name&gt;initialize-package-list&lt;/param-name&gt;
		&lt;param-value&gt;
			dataforms.app
			<b>,sample</b>
		&lt;/param-value&gt;
	&lt;/context-param&gt;
			</pre>
		</div>
		<h3>パスワードの保存方法</h3>
		<p>
			ユーザのパスワードはuser_infoテーブルに記録されます。
			その記録方式は可逆パスワード(暗号化)または不可逆パスワード(ハッシュ値)を指定することができます。
		</p>
		<div class="filecaption">パスワードの保存方法設定(web.xml)</div>
		<div class="wrappre">
			<pre>
	&lt;!-- &#12497;&#12473;&#12527;&#12540;&#12489;&#20445;&#23384;&#26041;&#27861; --&gt;
	&lt;context-param&gt;
		&lt;param-name&gt;password-type&lt;/param-name&gt;
		&lt;!--
			&#21487;&#36870;&#12497;&#12473;&#12527;&#12540;&#12489;:
			crypt-config&#12391;&#35373;&#23450;&#12375;&#12383;defaultPassword&#12434;&#20351;&#29992;&#12375;&#12390;&#12497;&#12473;&#12527;&#12540;&#12489;&#12434;&#26263;&#21495;&#21270;
		 --&gt;
		&lt;param-value&gt;REVERSIBLE_PASSWORD&lt;/param-value&gt;
		&lt;!--
			&#19981;&#21487;&#36870;&#12497;&#12473;&#12527;&#12540;&#12489;:
			hash-config&#12391;&#25351;&#23450;&#12375;&#12383;&#12450;&#12523;&#12468;&#12522;&#12474;&#12512;&#12391;&#12497;&#12473;&#12527;&#12540;&#12489;&#12434;&#12495;&#12483;&#12471;&#12517;&#21270;
		 --&gt;
		 &lt;!--
		&lt;param-value&gt;IRREVERSIBLE_PASSWORD&lt;/param-value&gt;
		  --&gt;
	&lt;/context-param&gt;

			</pre>
		</div>
		<p>
			不可逆パスワードを指定した場合、web.xmlのhash-algorithmパラメータで指定したアルゴリズムでハッシュ化します。
			データが第三者に渡った場合でも複合は困難な方式です。
			インターネットに公開し一般ユーザが登録するシステムの場合、不可逆パスワードの指定を推奨します。
		</p>
		<p>
			可逆パスワードを指定した場合は、crypt-configに設定したパスワード使用して元のパスワードを復元することが可能ですが、
			データが第三者に渡った場合複合される可能性は不可逆パスワードよりも高くなります。
			暗号化に使用するパスワードは、web.xmlのcrypt-configパラメータのdefaultPasswordで指定します。
			user_infoテーブル作成後パスワードを変更する場合、パスワード再暗号化ページを使用してください。
		</p>
		<h3>ユーザ認証設定</h3>
		<p>
			通常ログインIDとパスワードの確認のみで認証は完了しますが、
			さらにユーザのメールにワンタイムパスワードを送信することも可能です。
			以下の設定を有効にすると、ユーザIDとパスワードの確認後、
			ワンタイムパスワードをユーザのメールアドレスに送信し、ワンタイムパスワードの確認画面に遷移します。
			ワンタイムパスワードの確認が終了すると、ワンタイムパスワードキャンセルクッキーを発行します。
			このクッキーが存在する限りユーザIDとパスワードの入力で認証が完了します。
		</p>
		<p>
			クッキーの有効期限の間にログインしなかった場合、または別のブラウザでログインしようとした場合はワンタイムパスワードの確認が必要になります。
		</p>
		<div class="filecaption">ワンタイムパスワード設定(web.xml)</div>
		<div class="wrappre">
			<pre>
	&lt;!--
		&#12371;&#12398;&#35373;&#23450;&#12434;&#26377;&#21177;&#12395;&#12377;&#12427;&#12392;&#12289;&#35469;&#35388;&#26178;&#12395;&#12518;&#12540;&#12470;&#12398;&#12513;&#12540;&#12523;&#12450;&#12489;&#12524;&#12473;&#12395;&#12527;&#12531;&#12479;&#12452;&#12512;&#12497;&#12473;&#12527;&#12540;&#12489;&#12434;&#36865;&#20449;&#12375;
		&#12381;&#12398;&#30906;&#35469;&#12434;&#34892;&#12356;&#12414;&#12377;&#12290;
	 --&gt;
	&lt;context-param&gt;
		&lt;param-name&gt;onetime-password-config&lt;/param-name&gt;
		&lt;param-value&gt;
			{
				// &#12527;&#12531;&#12479;&#12452;&#12512;&#12497;&#12473;&#12527;&#12540;&#12489;&#12434;&#20351;&#29992;&#12377;&#12427;&#12363;&#12393;&#12358;&#12363;&#12290;
				&quot;useOnetimePassword&quot;: false,
				// &#12527;&#12531;&#12479;&#12452;&#12512;&#12497;&#12473;&#12527;&#12540;&#12489;&#25991;&#23383;&#25968;&#12290;
				&quot;length&quot;: 6,
				// &#12527;&#12531;&#12479;&#12452;&#12512;&#12497;&#12473;&#12527;&#12540;&#12489;&#12461;&#12515;&#12531;&#12475;&#12523;&#12463;&#12483;&#12461;&#12540;&#12398;&#26377;&#21177;&#26085;&#25968;
				// 0&#12434;&#25351;&#23450;&#12377;&#12427;&#12392;&#27598;&#22238;&#12527;&#12531;&#12479;&#12452;&#12512;&#12497;&#12473;&#12527;&#12540;&#12489;&#12434;&#30906;&#35469;&#12375;&#12414;&#12377;&#12290;
				// &#12381;&#12428;&#20197;&#22806;&#12398;&#22580;&#21512;&#22580;&#12463;&#12483;&#12461;&#12540;&#12364;&#23384;&#22312;&#12377;&#12427;&#12502;&#12521;&#12454;&#12470;&#12398;&#22580;&#21512;&#12289;&#12527;&#12531;&#12479;&#12452;&#12512;&#12497;&#12473;&#12527;&#12540;&#12489;&#12398;&#12481;&#12455;&#12483;&#12463;&#12399;&#34892;&#12431;&#12428;&#12414;&#12379;&#12435;&#12290;
				&quot;cookieExpiration&quot;: 20
			}
		&lt;/param-value&gt;
	&lt;/context-param&gt;
			</pre>
		</div>
		<p>
			この機能を有効にした場合、システムが自動的にメールを送信します。
			そのためTomcatのconf/context.xmlまたはWebウプリケーションのMETA-INF/context.xmlに、
			以下のメールセッション設定を追加する必要があります。
		</p>
		<div class="filecaption">メールセッション設定(context.xml)</div>
		<div class="wrappre">
			<pre>
	&lt;!--
		&#12513;&#12540;&#12523;&#36865;&#20449;&#27231;&#33021;&#12434;&#20351;&#29992;&#12377;&#12427;&#22580;&#21512;SMTP&#12469;&#12540;&#12496;&#12398;&#24773;&#22577;&#12434;&#36969;&#20999;&#12395;&#35373;&#23450;&#12375;&#12390;&#12367;&#12384;&#12373;&#12356;&#12290;
	 --&gt;
	&lt;Resource name=&quot;mail/Session&quot; auth=&quot;Container&quot; type=&quot;javax.mail.Session&quot;
		mail.smtp.host=&quot;localhost&quot; mail.smtp.port=&quot;25&quot; /&gt;
			</pre>
		</div>

		<h3>初期化時に作成するユーザレベルの設定</h3>
		<p>
			データベースの初期化時には、管理者(admin)または開発者(developer)レベルのユーザを1件登録します。
			ブランクアプリケーション(dfblank_xxx.war)は開発者向けにリリースされているため、
			以下のように開発者(developer)レベルのユーザを作成するように設定されています。
			完成されたアプリケーションの場合、開発者(developer)を作成する必要がなくなります。
			そのようば場合は、以下の設定を管理者(admin)に変更してください。
		</p>
		<div class="filecaption">初期化時に作成するユーザレベルの設定(web.xml)</div>
		<div class="wrappre">
			<pre>
	&lt;!--
		データベース初期化時に作成するユーザのレベルを指定します。
	 --&gt;
	&lt;context-param&gt;
		&lt;param-name&gt;initialize-user-level&lt;/param-name&gt;
		&lt;param-value&gt;developer&lt;/param-value&gt;
		&lt;!--
		&lt;param-value&gt;developer&lt;/param-value&gt;
		&lt;param-value&gt;admin&lt;/param-value&gt;
		--&gt;
	&lt;/context-param&gt;
			</pre>
		</div>
		<h3>WARファイルの作成</h3>
		<p>
			WARファイルはEclipseのWARエクスポート機能で簡単に作成することができます。
			プロジェクトを右クリックし「エクスポート」→「WARファイル」と選択してください。
			以下のダイアログで「宛先」を設定し「完了」ボタンを押下してください。
		</p>
		<figure>
			<figcaption>WARファイルのエクスポート</figcaption>
			<img src="warexp.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			この時ソースファイルのエクスポートにチェックを入れておくと、*.warファイル中にJavaのソースファイルも出力されます。
			こうしておくと*.warファイルをeclipseにインポートするだけでeclipseのプロジェクトになります。
		</p>
		<h2>デプロイ</h2>
		<h3>Tomcat9の設定</h3>
		<p>
			dataforms2.jarで作成されたアプリケーションを動作させるには、Java11とServlet3.0に対応したアプリケーションサーバが必要です。
			Java11+Tomcat9が稼働したサーバを用意してください。
		</p>
		<p>
			Tomcat9にはApache DerbyのJDBCドライバやJava mailをインストールする必要があります。
			「2.開発環境構築」の「2.2.データベースを用意する」と「2.3.Java mailのインストール」を参考にインストールを行ってください。
		</p>
		<h3>WARファイルのデプロイ</h3>
		<p>
			作成したWARファイルのデプロイを行うには、作成した*.warファイルを$CATALINA_HOME/webappsにコピーするだけです。
			これで自動的にデプロイが行われます。
		</p>
		<h3>アプリケーションの初期化</h3>
		<p>
			今回作成したアプリケーションのURLをアクセスすると、開発者の登録とデータベースの初期化を行う画面が表示されます。
			開発者の登録を行うと、dataforms.app,sampleパッケージ中のテーブルが作成され、初期データがインポートされます。
		</p>
		<figure>
			<figcaption>アプリケーションの初期化</figcaption>
			<img src="initapp1.png" style="width:50%; height:50%;"/>
		</figure>
		<p>
			初期化の完了後adminでログインすると、以下のように作成された機能を含むサイトマップが表示されます。
		</p>
		<figure>
			<figcaption>ログイン後のサイトマップ</figcaption>
			<img src="initapp2.png" style="width:50%; height:50%;"/>
		</figure>
		<hr/>
	</body>
</html>