<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>設定</title>
		<link type="text/css" href="../css/document.css" rel="stylesheet" />
		<style type="text/css">
			table.webxmlTable {
				table-layout: fixed;
			}
			table.webxmlTable td {
				vertical-align: middle;
				word-break: break-all;
			}
			table.webxmlTable td.commentOut {
				text-align: center;
			}
		</style>
	</head>
	<body>
		<h1 id="top"><span>4.1.</span>設定</h1>
		<h2>dataforms.conf.jsoncの主な設定項目</h2>
		<p>
			dataforms2.jarの各種設定はWEB-INF/web.xmlに記述していましたが、
			dataforms3.jar日の設定はWEB-INF/dataforms.conf.jsoncに移動しました。
			各種設定項目のコメントを参照し、適切に設定してください。
		</p>
		<p>
			以下に重要な設定項目を説明します。
		</p>
		<h3>開発ツール関係(developmentTool)</h3>
		<h4>開発ツールが出力するソースのパス</h4>
		<p>
			javaSourcePath,webSourcePathは開発ツールのJavaソースとHTMLやJavascriptソースを出力するパスを指定します。
			プロジェクト初期化画面で設定することができます。
			プロジェクト初期化画面ばEclipseの動的Webプロジェクトのフォルダー構成に従ったパスがデフォルト表示されます。
			他の開発ツールを使用する場合は適切に修正してください。
		</p>
		<h4>開発ツールの無効化</h4>
		<p>
			開発が完了したら開発ツールは不要になります。
			disableCodeGenerationToolをtrueに設定すれば、ソースを生成する開発ツールを無効にすることができます。
			disableDatabaseToolをtrueに設定すれば、データベースを操作する開発ツールを無効にすることができます。
			開発が完了しインターネットにシステムを公開する場合、開発ツールを無効にしておくことをお勧めします。
		</p>

		<h3>アプリケーションの初期化時の設定(initialize)</h3>
		<h4>データベースの初期化時に作成するユーザのレベル</h4>
		<p>
			開発が終了したWebアプリケーションを公開する場合、最初に登録するユーザは管理者レベルになります。
			userLevelをadminに設定すると、データベース初期化時に登録するユーザは管理者レベルになります。
		</p>
		<h4>データベース初期化を行うパッケージリスト</h4>
		<p>
			データベースの初期化のタイミングでjp.dataforms.fw.appパッケージ以下のTableクラスを見つけ出し、
			それに対応したテーブルを接続したデータベースに作成します。
			システムの開発作業では新規にパッケージが作成され、その中にテーブルクラスができてきます。
			完成したシステムを実行環境にデプロイするとき、
			その初期化処理で新たに追加されたテーブルを初期化するようにする必要があります。
		</p>
		<p>
			databasePackageListにはTableクラスを含むパッケージのリストを指定します。
			データベースの初期化処理は、このリストに指定されたパッケージ中のテーブルクラスに対応したテーブルを作成します。
		</p>
		<p>
			テーブルを含むパッケージを作成したら、必ずこのパラメータにパッケージを追加してください。
		</p>

		<h3>アプリケーション設定</h3>
		<h4>ブラウザのコンソールログ設定</h4>
		<p>
			Javascriptのデバッグ時にconsole.log等を使用しデバック情報をブラウザのコンソールに出力するケースがあります。
			dataforms3.jarではこのconsoleの代わりにloggerを使用します。
			loggerの使い方はconsoleと同じですが、clientLogLevelでログレベルを指定することができます。
			logger.logを大量に記述したコードでも、clientLogLevelをinfo以上にすることによって、
			ログの出力を抑制することができます。
		</p>
		<p>
			サーバサイドのログ出力はlog4j2を使用しています。そのの設定はlog4j2.xmlで行います。
		</p>
		<h4>複数言語対応</h4>
		<p>
			ブラウザの言語設定が日本語(ja)の状態でHogePage.htmlをアクセスすると、
			PageクラスはHogePage_ja.html(日本語用)をアクセスし、
			存在しなければHogePage.html(デフォルト言語用)をアクセスするようになっています。
			dataforms3.jar中に定義されているページのhtmlはデフォルト言語用と日本語用のページが用意されており、
			デフォルト言語用HTMLは英語のHTMLになっています。
		</p>
		<p>
			日本人のみを相手にするシステムではデフォルト言語用HTMLだけを作成しそれに日本語を記述するたけでOKですが、
			英語と日本語に対応しなければならない場合は、デフォルト言語用HTMLと日本語用HTMLを作成し、
			それぞれ英語と日本語で記述します。
		</p>
		<p>
			SelectFieldの選択肢を設定する列挙型管理テーブルには英語と日本語の設定欄が存在します。
			この機能で選択肢も英語と日本語の登録が可能になっています。
		</p>
		<p>
			英語と日本語以外の言語に対応する場合、languageListに言語コードを追加します。
			この設定を行うと列挙型管理に追加された言語の設定欄が表示されます。
		</p>
		<p>
			全て英語のシステムを作成しても、日本語設定のブラウザでアクセスするとdataforms3.jar内のページは日本語で表示されてしまいます。
			このようなページも英語表示させたい場合は、fixedLanguageパラメータにenを設定します。
			この設定を行うと、すべて英語ページが表示されます。
		</p>
		<h4>多要素認証設定</h4>
		<p>
			dataforms3.jarは多要素認証に対応しており、TOTP, Passkeyをサポートしています。
			mfaRequiredCountに0(デフォルト)が設定されていると、PasskeyやTOTPを設定しても、パスワードのみの認証が可能になっており、
			各ユーザの設定変更でパスワードのみのログインを禁止することができます。
			mfaRequiredCountに1以上を設定した場合、この回数以上多要素認証でのログインに成功すると、
			自動的にパスワードのみのログインが禁止されます。
		</p>
		<h4>データベース接続設定</h4>
		<p>
			dataforms3.jarはtomat10のcontex.xmlに設定されたJNDIデータソースを使用してデータベースをアクセスします。
			jndiDataSourceのjndiPrefixとdataSourceでJDNIデータソースの名称をしています。
			プロジェクト初期化画面はプロジェクト名に応じた、JNDIデータソースの設定ファイルを生成します。
		</p>
		<h4>メール送信設定</h4>
		<p>
			メールセッションの名称は"mail/Session"となっています。
			この名前が競合する場合mailのmailSessionで変更することができます。
		</p>
		<p>
			外部ユーザ登録等でメールを送信する場合があります。
			そのメールのfromはmailのmailFromで指定することができます。
		</p>
		<h4>デザイン切替</h4>
		<p>
			ページのフレームデザインは"/frame/flex"中の*.htmlと*.cssで指定しています。
			このパスはframe-Pathパラメータに設定されています。
			フレームのデザインを複数用意すると、サーバによってシステムのデザインを切り替えることができます。
		</p>
		<h4>既存ページの置き換え</h4>
		<p>
			dataforms3.jarではユーザ管理などの基本機能があらかじめ実装されています。
			これらの機能が非常にシンプルな機能であるため、別途高機能なページを作る必要が出てくる場合も存在します。
			この場合、既存の機能と新たに作ったページを置き換える必要が出てきます。
		</p>
		<p>
			pageOverrideにページクラスの置き換えルールを指定することができます。
			この機能を使用して既存のページをdataforms.app.base.page.HiddenPageに置き換えると、
			対象のページを隠すことができます。
		</p>
		<p>
			外部ユーザ登録機能などを使用しない場合、この機能を使用して該当するページを隠してください。
		</p>
		<h3>その他の設定項目</h3>
		<p>
			dataforms.conf.jsoncにはこの他にも多くの項目が存在します。
			設定ファイル中の解説にしたがって適切に修正してください。
		<h2>context.xml</h2>
		<p>
			プロジェクト初期化画面はMETA-INF/context.xmlファイルを作成します。
			このファイルにはメールセッションの設定例とデータベースへの接続設定例が記述されています。
		</p>
		<h3>メール設定</h3>
		<p>
			一般公開し外部からのユーザ登録を許可するシステムの場合、メール送信機能を使用します。
			このような場合有効なSMTPサーバの情報を設定しください。
		</p>
		<div class="filecaption">メールセッション設定(context.xml)</div>
		<div class="wrappre">
			<pre>
	&lt;!--
		&#12513;&#12540;&#12523;&#36865;&#20449;&#27231;&#33021;&#12434;&#20351;&#29992;&#12377;&#12427;&#22580;&#21512;SMTP&#12469;&#12540;&#12496;&#12398;&#24773;&#22577;&#12434;&#36969;&#20999;&#12395;&#35373;&#23450;&#12375;&#12390;&#12367;&#12384;&#12373;&#12356;&#12290;
	 --&gt;
	&lt;Resource name=&quot;mail/Session&quot; auth=&quot;Container&quot; type=&quot;javax.mail.Session&quot;
		mail.smtp.host=&quot;localhost&quot; mail.smtp.port=&quot;25&quot; /&gt;
			</pre>
		</div>
		<h3>データベース設定</h3>
		<p>
			データベースの接続設定は組み込みApache Derbyの接続設定例が有効になっています。
			このままApache Derbyを使用する場合、データベースファイルのパスを適切に変更して使用してください。
		</p>

		<div class="filecaption">Apache derbyの設定例(context.xml)</div>
		<div class="wrappre">
			<pre>
	&lt;!--
		&#32068;&#12415;&#36796;&#12415;Apache derby&#29992;&#12398;&#25509;&#32154;&#35373;&#23450;
		Apache derby&#12398;JDBC&#12489;&#12521;&#12452;&#12496;&#12399;&#21046;&#32004;&#21517;&#31216;&#12434;&#21462;&#24471;&#12377;&#12427;API&#12364;&#12354;&#12427;&#12383;&#12417;
		duplicateErrorMessage&#12392;foreignKeyErrorMessage&#12398;&#35373;&#23450;&#12399;&#19981;&#35201;&#12290;
	 --&gt;
	&lt;Resource auth=&quot;Container&quot;
		driverClassName=&quot;org.apache.derby.jdbc.EmbeddedDriver&quot;
		name=&quot;jdbc/dfdb&quot; type=&quot;javax.sql.DataSource&quot;
		url=&quot;jdbc:derby:./javadb/blankdb;create=true&quot;
		username=&quot;&quot; password=&quot;&quot; /&gt;
			</pre>
		</div>

		<p>
			PostgreSQL等のデータベースを使用する場合、Apache Derbyの接続設定をコメントアウトし、
			PostgreSQL等の接続設定を有効にして適切に変更してください。
			この設定変更だけで、データベースを切り替えることができます。
		</p>
		<p>
			Apache Derby以外のデータベースの場合duplicateErrorMessageとforeignKeyErrorMessageという変数が定義されています。
			Apache DerbyのJDBCドライバには一意制約違反や外部キー制約違反が発生した場合、
			その制約名を取得するAPIが存在しています。
			しかし、その他のデータベースの場合そのようなAPIが存在しないため、
			例外のメッセージから制約の名称を取得するようになっています。
			このようなメッセージはOSの言語設定やデータベースのバージョンによって異なる可能性があるため、
			使用する環境に応じて適切に修正する必要があります。
		</p>
		<h3>context.xmlの場所</h3>
		<p>
			META-INF/context.xmlはWebアプリケーション中の設定ファイルとなります。
			開発時やembsvでスタンドアロン運用する場合はこのままで良いのですが、
			別途運用するTomcatを用意する場合、&lt;TOMCATのインストールディレクトリ&gt;/conf/context.xmlにこれらの設定を移動します。
			Eclipseから起動する開発用Tomcatにはテスト用のデータベース接続設定をおこない、
			運用環境のTomcatには本番用のデータベース接続設定を行っておきます。
			こうしておくと、開発環境で作成したwarファイルを運用環境のCATALINA_HOME/webapps/にコピーするだけでデプロイが完了します。
		</p>
	</body>
</html>